# ref: https://github.com/TimeBye/registry-manager
name: Sync images to Tencent
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
jobs:
  ghcr-to-tencent:
    runs-on: ubuntu-20.04
    container: setzero/registry-manager
    env:
      TO_USERNAME: ${{ secrets.TENCENT_USERNAME }}
      TO_PASSWORD: ${{ secrets.TENCENT_PASSWORD }}
    steps:
      - name: Ghcr to Tencent force
        run: |
          cat << EOF >config.yaml
          registries:
            tencentyun:
              registry: https://ccr.ccs.tencentyun.com
              username: $TO_USERNAME
              password: $TO_PASSWORD
            ghcr:
              registry: https://ghcr.io
              repositories:
                - carllhw/onecontract-cloud_arms-agent
                - carllhw/onecontract-cloud_elasticsearch
                - carllhw/onecontract-cloud_frontbase
                - carllhw/onecontract-cloud_javabase
                - carllhw/onecontract-cloud_jnlp-agent-python
                - carllhw/onecontract-cloud_kibana
                - carllhw/onecontract-cloud_mysql-backup
                - carllhw/onecontract-cloud_openvpn
                - carllhw/onecontract-cloud_rustbase
          sync-policy:
            from: ghcr
            to: tencentyun
            force: true
            dry-run: false
            replace:
              - old: carllhw/onecontract-cloud_
                new: onecontract-cloud/
          EOF
          registry-manager sync -c config.yaml
      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 3
  dockerhub-to-tencent:
    runs-on: ubuntu-20.04
    container: setzero/registry-manager
    env:
      TO_USERNAME: ${{ secrets.TENCENT_USERNAME }}
      TO_PASSWORD: ${{ secrets.TENCENT_PASSWORD }}
    steps:
      - name: Dockerhub to Tencent
        run: |
          cat << EOF >config.yaml
          registries:
            tencentyun:
              registry: https://ccr.ccs.tencentyun.com
              username: $TO_USERNAME
              password: $TO_PASSWORD
            dockerhub:
              registry: https://registry-1.docker.io
              repositories:
                - apache/skywalking-java-agent:8.8.0-alpine
                - apache/skywalking-oap-server:8.9.0
                - apache/skywalking-ui:8.9.0
                - grafana/grafana:8.2.6
                - grafana/loki:2.4.1
                - grafana/promtail:2.4.1
                - hengyunabc/arthas:3.5.5-no-jdk
                - istio/install-cni:1.11.5
                - istio/operator:1.11.5
                - istio/pilot:1.11.5
                - istio/proxyv2:1.11.5
                - jenkins/jenkins:2.328-jdk11
                - jettech/kube-webhook-certgen:v1.5.2
                - jimmidyson/configmap-reload:v0.5.0
                - library/httpd:2.4.51
                - library/mysql:5.7.36
                - library/nginx:1.20.2
                - library/redis:5.0.14
                - minio/operator:v4.3.6
                - minio/minio:RELEASE.2021-11-03T03-36-36Z
                - sonatype/nexus3:3.37.3
          sync-policy:
            from: dockerhub
            to: tencentyun
            dry-run: false
            replace:
              - old: apache/
                new: onecontract-cloud/apache_
              - old: grafana/
                new: onecontract-cloud/grafana_
              - old: hengyunabc/
                new: onecontract-cloud/hengyunabc_
              - old: istio/
                new: onecontract-cloud/istio_
              - old: jenkins/
                new: onecontract-cloud/jenkins_
              - old: jettech/
                new: onecontract-cloud/jettech_
              - old: jimmidyson/
                new: onecontract-cloud/jimmidyson_
              - old: library
                new: onecontract-cloud
              - old: minio/
                new: onecontract-cloud/minio_
              - old: sonatype/
                new: onecontract-cloud/sonatype_
          EOF
          registry-manager sync -c config.yaml
      - name: Dockerhub to Tencent force
        run: |
          cat << EOF >config.yaml
          registries:
            tencentyun:
              registry: https://ccr.ccs.tencentyun.com
              username: $TO_USERNAME
              password: $TO_PASSWORD
            dockerhub:
              registry: https://registry-1.docker.io
              repositories:
                - library/busybox:latest
                - library/httpd:latest
                - library/httpd:2.4
                - library/nginx:latest
                - library/nginx:stable
                - library/nginx:1.20
                - library/mysql:5.7
                - library/redis:5.0
                - minio/minio:latest
          sync-policy:
            from: dockerhub
            to: tencentyun
            force: true
            dry-run: false
            replace:
              - old: library
                new: onecontract-cloud
              - old: minio/
                new: onecontract-cloud/minio_
          EOF
          registry-manager sync -c config.yaml
      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 3
  quay-to-tencent:
    runs-on: ubuntu-20.04
    container: setzero/registry-manager
    env:
      TO_USERNAME: ${{ secrets.TENCENT_USERNAME }}
      TO_PASSWORD: ${{ secrets.TENCENT_PASSWORD }}
    steps:
      - name: Quay to Tencent
        run: |
          cat << EOF >config.yaml
          registries:
            tencentyun:
              registry: https://ccr.ccs.tencentyun.com
              username: $TO_USERNAME
              password: $TO_PASSWORD
            quay:
              registry: https://quay.io
              repositories:
                - prometheus/alertmanager:v0.23.0
                - prometheus/node-exporter:v1.3.1
                - prometheus/pushgateway:v1.4.2
                - prometheus/prometheus:v2.31.1
                - thanos/thanos:v0.23.1
          sync-policy:
            from: quay
            to: tencentyun
            dry-run: false
            replace:
              - old: prometheus/
                new: onecontract-cloud/prometheus_
              - old: thanos/
                new: onecontract-cloud/thanos_
          EOF
          registry-manager sync -c config.yaml
      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 3
  gcr-to-tencent:
    runs-on: ubuntu-20.04
    container: setzero/registry-manager
    env:
      TO_USERNAME: ${{ secrets.TENCENT_USERNAME }}
      TO_PASSWORD: ${{ secrets.TENCENT_PASSWORD }}
    steps:
      - name: Gcr to Tencent
        run: |
          cat << EOF >config.yaml
          registries:
            tencentyun:
              registry: https://ccr.ccs.tencentyun.com
              username: $TO_USERNAME
              password: $TO_PASSWORD
            gcr:
              registry: https://k8s.gcr.io
              repositories:
                - defaultbackend-amd64:1.5
                - ingress-nginx/controller:v1.1.0
                - kube-state-metrics/kube-state-metrics:v2.2.4
                - node-problem-detector/node-problem-detector:v0.8.10
          sync-policy:
            from: gcr
            to: tencentyun
            dry-run: false
            replace:
              - old: ingress-nginx/
                new: onecontract-cloud/ingress-nginx_
              - old: kube-state-metrics/
                new: onecontract-cloud/prometheus_
              - old: node-problem-detector/
                new: onecontract-cloud/node-problem-detector_
              - new: onecontract-cloud
          EOF
          registry-manager sync -c config.yaml
      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 3
